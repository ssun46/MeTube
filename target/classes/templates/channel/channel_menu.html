<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
	
<head th:replace="fragment/includes :: heads"></head>

<link rel="stylesheet" th:href="@{/css/channel-ui.css}">

<script th:src="@{/js/channel.js}"></script>

<body>
	<div th:replace="fragment/header :: header"></div>
	
	<div class="top-offset content bg-white-gray">
		<div class="px-7 pt-3" style="padding-bottom: 4px;">
			<div class="media align-items-center" style="width: 100%;">
				<div class="thumbnail-area">
					<a class="text-center align-items-center rounded-circle bg-success font-weight-bold text-white" style="width: 100%; height: 100%;"
						th:alt="${user.display_name}" th:text="${#strings.substring(user.display_name, 0, 1)}"
					 	th:if="${user.thumbnail_yn.toString()} == 'N'">
				 	</a> 	
					<a>
						<img th:src="@{/profile/thumbnail/} + ${user.id}" class="align-self-center rounded-circle" style="width: 100%; height: 100%;"
							th:unless="${user.thumbnail_yn.toString()} == 'N'">
					</a>
					<a id="profile_upload_button" onclick="javascript:thumbnail_upload();" class="overlay rounded-circle align-items-center">
						<img th:src="@{/img/button_camera.png}">
					</a>
				</div>
				<div class="d-flex justify-content-between media-body pl-3">
					<h4 class="mt-0" th:text="${user.display_name}" style="line-height: 1.5;"></h4>
					<a><input type="button" onclick="javascript:video_upload();" class="btn btn-deepblue" value="동영상 업로드" /></a>
				</div>
			</div>
		</div>
		<div class="content bg-white-gray px-6 pt-3">
			<ul class="nav nav-tabs align-center" id="myTab" role="tablist">
				<li class="nav-item" role="presentation">
					<a class="nav-link text-center active" id="home-tab" data-toggle="tab"
						href="#home" role="tab" aria-controls="home" aria-selected="true">홈</a>
				</li>
				<li class="nav-item" role="presentation">
					<a class="nav-link text-center" id="media-tab" data-toggle="tab"
						href="#media" role="tab" aria-controls="media" aria-selected="false">동영상</a>
				</li>
				<li class="nav-item" role="presentation">
					<a class="nav-link text-center sm-mx-n3" id="watched-tab" data-toggle="tab"
						href="#watched" role="tab" aria-controls="watched" aria-selected="false">재생목록</a>
				</li>
				<li class="nav-item" role="presentation">
					<a class="nav-link text-center" id="subcribe-tab" data-toggle="tab"
						href="#subcribe" role="tab" aria-controls="subcribe" aria-selected="false">채널</a>
				</li>
				<li class="nav-item" role="presentation">
					<a class="nav-link text-center" id="info-tab" data-toggle="tab"
						href="#info" role="tab" aria-controls="info" aria-selected="false">정보</a>
				</li>
			</ul>
		</div>
	</div>
	
	<div class="top-offset bg-gray">
		<div class="tab-content" id="myTabContent">
			<div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
				<div th:replace="/channel/channel_home :: channel_home"></div>
			</div>
			<div class="tab-pane fade show" id="media" role="tabpanel" aria-labelledby="media-tab">
				<div th:replace="/channel/channel_media :: channel_media"></div>
			</div>
			<div class="tab-pane fade show" id="watched" role="tabpanel" aria-labelledby="watched-tab">
				<div th:replace="/channel/channel_watched :: channel_watched"></div>
			</div>
			<div class="tab-pane fade show" id="subcribe" role="tabpanel" aria-labelledby="subcribe-tab">
				<div th:replace="/channel/channel_subcribe :: channel_subcribe"></div>
			</div>
			<div class="tab-pane fade show" id="info" role="tabpanel" aria-labelledby="info-tab">
				<div th:replace="/channel/channel_info :: channel_info"></div>
			</div>
		</div>
	</div>
	
	<div th:replace="/fragment/popups :: profile_upload"></div>
	<div th:replace="/fragment/popups :: video_upload"></div>
</body>

<script th:inline="javascript">
	var uploadUrl = /*[[@{/upload}]]*/;
	var categoriesUrl = /*[[@{/contents/categories}]]*/;
	var saveUrl = /*[[@{/contents/saveContent}]]*/;
	
	//Register the plugin
	FilePond.registerPlugin(
		FilePondPluginImagePreview,
		FilePondPluginImageResize,
		FilePondPluginFileValidateType,
		FilePondPluginFileValidateSize
	);
	
	const inputProfileImage = document.querySelector(".profile_filepond");
	const profilePond = FilePond.create(inputProfileImage, {
		imageResizeTargetWidth: 256,
		imageResizeMode: "contain",
		allowFileTypeValidation: true,
		acceptedFileTypes: ['image/png', 'image/jpeg'],
		allowFileSizeValidation: true,
		maxFileSize: "5MB",
		
		onaddfile: (error, file) => {
		    if (error) {
		        profilePond.removeFile();
		        alert(error.main + "\n" + error.sub);
		        return;
		    }
		    console.log('profile added', file.filename);
		},
		
		labelIdle: '프로필 이미지 업로드<span class="filepond--label-action"></span>',
		server: {
        	process:(fieldName, file, metadata, load, error, progress, abort, transfer, options) => {

                // fieldName is the name of the input field
                // file is the actual file object to send
                const formData = new FormData();
                formData.append(fieldName, file, file.name);

                const request = new XMLHttpRequest();
                request.open('POST', uploadUrl + '/profile/image');

                // Should call the progress method to update the progress to 100% before calling load
                // Setting computable to false switches the loading indicator to infinite mode
                request.upload.onprogress = (e) => {
                    progress(e.lengthComputable, e.loaded, e.total);
                };

                // Should call the load method when done and pass the returned server file id
                // this server file id is then used later on when reverting or restoring a file
                // so your server knows which file to return without exposing that info to the client
                request.onload = function() {
                    if (request.status >= 200 && request.status < 300) {
                        // the load method accepts either a string (id) or an object
                        load(request.responseText);
                        if(request.responseText) {
                        	alert("프로필 이미지가 업로드 되었습니다.");
                        	location.reload(true);
                        }
                    }
                    else {
                    	profilePond.removeFile();
                        // Can call the error method if something is wrong, should exit after
                        error('oh no');
                    }
                };

                request.send(formData);
                
                // Should expose an abort method so the request can be cancelled
                return {
                    abort: () => {
                        // This function is entered if the user has tapped the cancel button
                        request.abort();

                        // Let FilePond know the request has been cancelled
                        abort();
                    }
                };
            }
	    }
		
	});
	
	const inputVideo = document.querySelector(".video_filepond");
	const videoPond = FilePond.create(inputVideo, {
		allowFileTypeValidation: true,
		acceptedFileTypes: ['video/*'],
		allowFileSizeValidation: false,
		
		onaddfile: (error, file) => {
		    if (error) {
		        videoPond.removeFile();
		        alert(error.main + "\n" + error.sub);
		        return;
		    }
		    console.log('video added', file.filename);
		},
		
		labelIdle: "<a><span style='font-size: 14px !important;'>동영상 파일을 드래그 앤 드롭하여 업로드</span>" +
					"<span style='font-size: 14px !important; color: #606060;'><br/>동영상을 게시하기 전에는 비공개로 설정됩니다.</span>" +
					"<span class='filepond--label-action'></span></a>",
		server: {
			process:(fieldName, file, metadata, load, error, progress, abort, transfer, options) => {
			
			    // fieldName is the name of the input field
			    // file is the actual file object to send
			    const formData = new FormData();
			    formData.append(fieldName, file, file.name);
			    			
			    const request = new XMLHttpRequest();
			    request.open('POST', uploadUrl + '/video');
			    
			    // Should call the progress method to update the progress to 100% before calling load
			    // Setting computable to false switches the loading indicator to infinite mode
			    request.upload.onprogress = (e) => {
			        progress(e.lengthComputable, e.loaded, e.total);
			    };
			
			    // Should call the load method when done and pass the returned server file id
			    // this server file id is then used later on when reverting or restoring a file
			    // so your server knows which file to return without exposing that info to the client
			    request.onload = function() {
			        if (request.status >= 200 && request.status < 300) {
			            // the load method accepts either a string (id) or an object
			            load(request.responseText);
			            if(request.responseText == null || request.responseText == "0") {
			            	alert("파일 업로드에 실패했습니다.");
			            } else {
			            	getCategories();
			            	console.log(request.responseText)
			            	var returnValue = request.responseText.split(",");
			            	$("#video_upload_area").prop("style", "display: none;");
			            	$("#video_info_area").prop("style", "");
			            	$("input[name=id]")[0].value = returnValue[0];
			            	$("#name").val(returnValue[1]);
			            	getNameLength();
			            }
				        videoPond.removeFile();
			        }
			        else {
				        videoPond.removeFile();
			            // Can call the error method if something is wrong, should exit after
			            error('oh no');
			        }
			    };
			
			    request.send(formData);
			    
			    // Should expose an abort method so the request can be cancelled
			    return {
			        abort: () => {
			            // This function is entered if the user has tapped the cancel button
			            request.abort();
			
			            // Let FilePond know the request has been cancelled
			            abort();
			        }
			    };
			}
		}		
	});
	
	const videoThumbnailImage = document.querySelector(".thumbnail_filepond");
	const thumbnailPond = FilePond.create(videoThumbnailImage, {
		imageResizeTargetWidth: 256,
		imageResizeMode: "contain",
		allowFileTypeValidation: true,
		acceptedFileTypes: ['image/png', 'image/jpeg'],
		allowFileSizeValidation: true,
		maxFileSize: "5MB",
		
		onaddfile: (error, file) => {
		    if (error) {
		    	thumbnailPond.removeFile();
		        alert(error.main + "\n" + error.sub);
		        return;
		    }
		    console.log('thumbnail added', file.filename);
		},
		
		labelIdle: '<a><span style="font-size: 12px;">동영상의 내용을 알려주는 이미지를 등록하세요</span><span class="filepond--label-action"></span></a>',
		server: {
        	process:(fieldName, file, metadata, load, error, progress, abort, transfer, options) => {

                // fieldName is the name of the input field
                // file is the actual file object to send
                const formData = new FormData();
                formData.append(fieldName, file, file.name);
                formData.append("id", $("input[name=id]").val());
			    
                const request = new XMLHttpRequest();
                request.open('POST', uploadUrl + '/video/thumbnail');
                
                // Should call the progress method to update the progress to 100% before calling load
                // Setting computable to false switches the loading indicator to infinite mode
                request.upload.onprogress = (e) => {
                    progress(e.lengthComputable, e.loaded, e.total);
                };
                
                // Should call the load method when done and pass the returned server file id
                // this server file id is then used later on when reverting or restoring a file
                // so your server knows which file to return without exposing that info to the client
                request.onload = function() {
                    if (request.status >= 200 && request.status < 300) {
                        // the load method accepts either a string (id) or an object
                        load(request.responseText);
                        if(request.responseText) {
                        	if(request.responseText == "error") {
                        		alert("미리보기 이미지 업로드 중 오류가 발생했습니다.");
                  				thumbnailPond.removeFile();
                        	} else {
                        		console.log(request.responseText);
                        	}
                        }
                    }
                    else {
                    	thumbnailPond.removeFile();
                        // Can call the error method if something is wrong, should exit after
                        error('oh no');
                    }
                };

                request.send(formData);
                
                // Should expose an abort method so the request can be cancelled
                return {
                    abort: () => {
                        // This function is entered if the user has tapped the cancel button
                        request.abort();

                        // Let FilePond know the request has been cancelled
                        abort();
                    }
                };
            }
	    }
		
	});
	
	$(function() {
		init_profile_upload_dialog();
		init_video_upload_dialog();
	});
</script>
</html>